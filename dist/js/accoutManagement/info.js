define(["jquery","text!tpls/accoutManagementInfo.html","artTemplate","common/amdApi","datetime"],function(n,a,e,t){return function(o){n(".dropdown-menu").remove(),o=parseInt(o),t.ajax({url:"customers/"+o,type:"get"},function(r){var l=e.render(a,r.result),c=n(l).on("click",".btn-cancel,.account",function(){n(".accoutManagement").trigger("click")});c.find(".kandao-date").datetimepicker({format:"yyyy-mm-dd",language:"zh-CN",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0}),n(".kandao-contentBody").html(c);var u=r.result.language,d=n("#language option");!function(n,a){for(i=0;i<n.length;i++)n[i].value==a&&(n[i].selected=!0)}(d,u);var s=[],p=[];n(".pinBox").on("click","span",function(a){var e=n(this).parent().attr("sn-id");p.push(e),n(a.currentTarget.parentElement).hide()}),c.on("click",".btn-add",function(a){a.preventDefault();var e=n('#kandao-info input[name="sn"]').val(),i=n('#kandao-info input[name="pin"]').val(),r={sn:e,pin:i};t.ajax({url:"customers/"+o+"/cameras/add",type:"post",json:JSON.stringify(r)},function(a){var t=!0;if(s.forEach(function(n,e){if(n==a.result.sn_id)return alert("该相机已经绑定了该客户，不能重复绑定"),void(t=!1)}),t){var o='<div class="pinBox" sn-id="'+a.result.sn_id+'">'+e+"&nbsp;"+i+'<span class="glyphicon glyphicon-remove-circle"></span></div>';n(".pinOptions").append(o),s.push(a.result.sn_id),n(".pinBox").on("click","span",function(a){var e=n(this).parent().attr("sn-id");s.forEach(function(n,a){return n==e&&s.splice(a,1),!1}),n(a.currentTarget.parentElement).hide()})}})}),n(".kandao-accout-top").on("click",".btn-save",function(a){a.preventDefault(),n(this).attr("id",o);var e=n(".accoutList li").eq(1).attr("nowPage");e=parseInt(e);var i=(n('#kandao-info input[name="email"]').val(),n('#kandao-info input[name="name"]').val()),r=n('#kandao-info select[name="language"]').val(),l=n('#kandao-info input[name="company"]').val(),c=n('#kandao-info input[name="address"]').val(),u=n('#kandao-info input[name="phone"]').val(),d=n('#kandao-info input[name="finaltime"]').val(),m=n('#kandao-info input[name="licenseN"]').val(),f=n('#kandao-info input[name="enableofflinewatermark"]:checked').val(),v=n('#kandao-info input[name="enableonlinewatermark"]:checked').val();if(f="1"==f,v="1"==v,!n.trim(i+"")||!n.trim(l+"")||!n.trim(m+""))return void alert("请添加姓名/公司/设备数量信息后提交！");if((m=parseInt(m))<=0)return void alert("请添加正常的设备数量！");var g={id:o,phone:u,name:i,language:r,company:l,address:c,enableofflinewatermark:f,enableonlinewatermark:v,finaltime:d,licenseN:m,add_sn:s.join(","),del_sn:p.join(",")};t.ajax({url:"customers/"+o+"/change",type:"post",json:JSON.stringify(g)},function(a){alert("保存成功！"),n(".accoutManagement").trigger("click")})})})}});