define(["jquery","text!tpls/mediaManagement/mediaLibraryAdd.html","artTemplate","common/amdApi","mediaManagement/getCloumnId","mediaManagement/getTagName","mediaManagement/uploadFileRms","bootstrap","page","upload"],function(e,i,a,t,l,n,o){return function(o,d){function r(){"live"==e("select.resorce").val()?(e("div.resourceFile").css("display","none"),e("div.streamAddress").css("display","block")):(e("select.resorce").val(),e("div.streamAddress").css("display","none"),e("div.resourceFile").css("display","block"))}e("#addMedia").remove();var s,c={},u=[],p=[],f=a.render(i,o.result),m=e(f).on("click",".cloumnAdd",function(){var i=e(this).prev("#tagSel").val(),a=e("#tagSel option:selected").text();l(i,a,m,".cloumnAddBox",u)}).on("click",".tagAdd",function(){var i=e(this).prev().val();n(i,m,".tagAddBox",p)}).on("click",".uploadSubmit",function(i){i.preventDefault();var a=e('#addMedia input[name="name"]').val(),l=e('#addMedia textarea[name="description"]').val();if(s=e('#addMedia select[name="type"]').val(),!e.trim(a)||!e.trim(l)||!e.trim(s))return void alert("请输入名称/描述/类型等信息！");if(c.name=a,c.description=l,c.type=s,c.add_column=u.join(","),c.add_tag=p.join(","),c.del_colum="",c.del_tag="",!c.file_name||e("#uploadifive-sourceFile-queue .fileinfo").text().indexOf("Error")>-1)return void alert("请正确上传源文件(视频仅支持.mp4格式，图片支持.jpg格式)！");var n=c.file_name;switch(c.extension_name=n.substring(n.lastIndexOf(".")+1,n.length).toLowerCase(),s){case"video":if("mp4"!==c.extension_name)return void alert("视频仅支持.mp4后缀的文件！");break;case"photo":if("jpg"!==c.extension_name)return void alert("图片仅支持.jpg后缀的文件！")}if(e("#addMedia .thumbnail img").length>0&&-1==e("#addMedia #picID").val().indexOf(".jpg"))return void alert("缩略图请使用后缀为.jpg的图片！");t.ajax({url:"medias/add",type:"post",json:JSON.stringify(c)},function(i){if(m.modal("hide"),e(".modal-backdrop").hide(),m.find(".fileinput-exists img").length>0){d.flag=!1;var a=new FormData(m.find("#mediaAddImg")[0]);e.ajax({url:t.getFileUrl()+"upload_action/",type:"post",data:a,cache:!1,contentType:!1,processData:!1,success:function(e){e.msg?console.log("upload success"):console.log(e.msg),d.flag=!0;var a={file_hash:e.file_hash,file_url:e.file_url,type:s,pk:i.result.id,file_name:e.file_name,file_size:e.file_size,file_type:e.file_type};t.ajax({url:"medias/upload/thumbnail",type:"post",json:JSON.stringify(a)},function(e){})},error:function(e){d.flag=!0,console.log(e.msg)}})}d.flag=!0,setTimeout(function(){e(".mediaLibrary").click()},500)})}).appendTo("body").modal();r(),e("select.resorce").on("change",function(){r()}),function(){e(function(){e("#sourceFile").uploadifive({auto:!0,method:"post",uploadScript:t.getFileUrl()+"upload_action/",fileObjName:"upload",buttonText:"选择文件",fileType:!1,uploadLimit:1,queueSizeLimit:1,fileTypeExts:"*.mp4; *.jpg",onUploadComplete:function(e,i){var i=JSON.parse(i);c.file_hash=i.file_hash,c.file_name=i.file_name,c.file_url=i.file_url,c.file_type=i.file_type,c.file_size=i.file_size},onCancel:function(i){e("#addMedia #picID").val(""),e("#frontSide").val(""),$data=e(this).data("uploadifive"),settings=$data.settings,settings.uploadLimit++},onFallback:function(){alert("该浏览器无法使用!")},onUploadError:function(){alert("文件上传失败，请检查文件类型重新上传！")}})})}()}});